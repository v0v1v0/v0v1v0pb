<div class="container">

<table style="width: 100%;"><tr>
<td>custom_family</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Custom Families in <span class="pkg">brms</span> Models</h2>

<h3>Description</h3>

<p>Define custom families (i.e. response distribution) for use in
<span class="pkg">brms</span> models. It allows users to benefit from the modeling
flexibility of <span class="pkg">brms</span>, while applying their self-defined likelihood
functions. All of the post-processing methods for <code>brmsfit</code>
objects can be made compatible with custom families.
See <code>vignette("brms_customfamilies")</code> for more details.
For a list of built-in families see <code>brmsfamily</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">custom_family(
  name,
  dpars = "mu",
  links = "identity",
  type = c("real", "int"),
  lb = NA,
  ub = NA,
  vars = NULL,
  loop = TRUE,
  specials = NULL,
  threshold = "flexible",
  log_lik = NULL,
  posterior_predict = NULL,
  posterior_epred = NULL,
  predict = NULL,
  fitted = NULL,
  env = parent.frame()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>name</code></td>
<td>
<p>Name of the custom family.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dpars</code></td>
<td>
<p>Names of the distributional parameters of
the family. One parameter must be named <code>"mu"</code> and
the main formula of the model will correspond to that
parameter.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>links</code></td>
<td>
<p>Names of the link functions of the
distributional parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>Indicates if the response distribution is
continuous (<code>"real"</code>) or discrete (<code>"int"</code>). This controls
if the corresponding density function will be named with
<code>&lt;name&gt;_lpdf</code> or <code>&lt;name&gt;_lpmf</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lb</code></td>
<td>
<p>Vector of lower bounds of the distributional
parameters. Defaults to <code>NA</code> that is no lower bound.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ub</code></td>
<td>
<p>Vector of upper bounds of the distributional
parameters. Defaults to <code>NA</code> that is no upper bound.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vars</code></td>
<td>
<p>Names of variables that are part of the likelihood function
without being distributional parameters. That is, <code>vars</code> can be used
to pass data to the likelihood. Such arguments will be added to the list of
function arguments at the end, after the distributional parameters. See
<code>stanvar</code> for details about adding self-defined data to the
generated <span class="pkg">Stan</span> model. Addition arguments <code>vreal</code> and <code>vint</code>
may be used for this purpose as well (see Examples below). See also
<code>brmsformula</code> and <code>addition-terms</code> for more
details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loop</code></td>
<td>
<p>Logical; Should the likelihood be evaluated via a loop
(<code>TRUE</code>; the default) over observations in Stan?
If <code>FALSE</code>, the Stan code will be written in a vectorized
manner over observations if possible.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>specials</code></td>
<td>
<p>A character vector of special options to enable
for this custom family. Currently for internal use only.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold</code></td>
<td>
<p>Optional threshold type for custom ordinal families.
Ignored for non-ordinal families.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>log_lik</code></td>
<td>
<p>Optional function to compute log-likelihood values of
the model in <span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span>. This is only relevant if one wants to ensure
compatibility with method <code>log_lik</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>posterior_predict</code></td>
<td>
<p>Optional function to compute posterior prediction of
the model in <span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span>. This is only relevant if one wants to ensure compatibility
with method <code>posterior_predict</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>posterior_epred</code></td>
<td>
<p>Optional function to compute expected values of the
posterior predictive distribution of the model in <span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span>. This is only relevant
if one wants to ensure compatibility with method
<code>posterior_epred</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predict</code></td>
<td>
<p>Deprecated alias of 'posterior_predict'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fitted</code></td>
<td>
<p>Deprecated alias of 'posterior_epred'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>env</code></td>
<td>
<p>An <code>environment</code> in which certain post-processing
functions related to the custom family can be found, if there were not
directly passed to <code>custom_family</code>. This is only
relevant if one wants to ensure compatibility with the methods
<code>log_lik</code>,
<code>posterior_predict</code>, or
<code>posterior_epred</code>.
By default, <code>env</code> is the environment from which
<code>custom_family</code> is called.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The corresponding probability density or mass <code>Stan</code>
functions need to have the same name as the custom family.
That is if a family is called <code>myfamily</code>, then the
<span class="pkg">Stan</span> functions should be called <code>myfamily_lpdf</code> or
<code>myfamily_lpmf</code> depending on whether it defines a
continuous or discrete distribution.
</p>


<h3>Value</h3>

<p>An object of class <code>customfamily</code> inheriting
from class <code>brmsfamily</code>.
</p>


<h3>See Also</h3>

<p><code>brmsfamily</code>, <code>brmsformula</code>,
<code>stanvar</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
## demonstrate how to fit a beta-binomial model
## generate some fake data
phi &lt;- 0.7
n &lt;- 300
z &lt;- rnorm(n, sd = 0.2)
ntrials &lt;- sample(1:10, n, replace = TRUE)
eta &lt;- 1 + z
mu &lt;- exp(eta) / (1 + exp(eta))
a &lt;- mu * phi
b &lt;- (1 - mu) * phi
p &lt;- rbeta(n, a, b)
y &lt;- rbinom(n, ntrials, p)
dat &lt;- data.frame(y, z, ntrials)

# define a custom family
beta_binomial2 &lt;- custom_family(
  "beta_binomial2", dpars = c("mu", "phi"),
  links = c("logit", "log"), lb = c(NA, 0),
  type = "int", vars = "vint1[n]"
)

# define the corresponding Stan density function
stan_density &lt;- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int N) {
    return beta_binomial_lpmf(y | N, mu * phi, (1 - mu) * phi);
  }
"
stanvars &lt;- stanvar(scode = stan_density, block = "functions")

# fit the model
fit &lt;- brm(y | vint(ntrials) ~ z, data = dat,
           family = beta_binomial2, stanvars = stanvars)
summary(fit)


# define a *vectorized* custom family (no loop over observations)
# notice also that 'vint' no longer has an observation index
beta_binomial2_vec &lt;- custom_family(
  "beta_binomial2", dpars = c("mu", "phi"),
  links = c("logit", "log"), lb = c(NA, 0),
  type = "int", vars = "vint1", loop = FALSE
)

# define the corresponding Stan density function
stan_density_vec &lt;- "
  real beta_binomial2_lpmf(array[] int y, vector mu, real phi, array[] int N) {
    return beta_binomial_lpmf(y | N, mu * phi, (1 - mu) * phi);
  }
"
stanvars_vec &lt;- stanvar(scode = stan_density_vec, block = "functions")

# fit the model
fit_vec &lt;- brm(y | vint(ntrials) ~ z, data = dat,
           family = beta_binomial2_vec,
           stanvars = stanvars_vec)
summary(fit_vec)

## End(Not run)

</code></pre>


</div>