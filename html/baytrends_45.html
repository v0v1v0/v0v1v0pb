<div class="container">

<table style="width: 100%;"><tr>
<td>detrended.salinity</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create Seasonally Detrended Salinty Data Set</h2>

<h3>Description</h3>

<p>This function creates a seasonally detrended salinity data set 
for selected stations. The created data set is used to support application 
of GAMs that include a hydrologic term as one of the independent variables.
The output from this function should be stored as an .rda file for repeated
use with baytrends.
</p>


<h3>Usage</h3>

<pre><code class="language-R">detrended.salinity(
  df.sal,
  dvAvgWinSel = 30,
  lowess.f = 0.2,
  minObs = 40,
  minObs.sd = 10
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>df.sal</code></td>
<td>
<p>data frame with salinty data (required variables in data frame
are: station, date, layer, and salinity)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dvAvgWinSel</code></td>
<td>
<p>Averaging window (days) selection for pooling data to 
compute summary statistics</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lowess.f</code></td>
<td>
<p>lowess smoother span applied to computed standard deviation
(see Details). This gives the proportion of points which influence the
smooth at each value. Larger values give more smoothness.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minObs</code></td>
<td>
<p>Minimum number of observations for performing analysis (default
is 40)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minObs.sd</code></td>
<td>
<p>Minimum number of observations in averaging window for
calculation of the standard deviation (default is 10)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function returns a list of seasonally detrended salinity and 
companion statistics; and relies on a user supplied data frame that 
contains the following variables: station, date, layer, and salinity. See
structure of sal data in example below.  
</p>
<p>It is the user responsibility to save the resulting list as
<b>salinity.detrended</b> for integration with baytrends.
</p>
<p>For the purposes of baytrends, it is expected that the user would identify
a data set with all salinity data that are expected to be evaluated so that
a single data file is created. The following computation steps are
performed: 
</p>
<p>1) Extract the list of stations, minimum year, and maximum year in data 
set. Initialize the <b>salinity.detrended</b> list with this information 
along with meta data documenting the retrieval parameters. 
</p>
<p>2) Downselect the input data frame to only include data where the 
layer is equal to 'S', 'AP', 'BP' or 'B'.
</p>
<p>3) Average the 'S' and 'AP' salinity data; and the 'B' and 'BP salinity
data together to create average salinity values for SAP (surface and above 
pycnocline) and BBP (bottom and below pycnocline), respectively. These 
values are stored as the variables, <b>salinity.SAP</b> and 
<b>salinity.BBP</b> together with the <b>date</b> and day of year 
(<b>doy</b>) in a data frame corresponding to the station ID.
</p>
<p>4) For each station/layer combination with atleast <b>minObs</b>
observations, a seasonal GAM, i.e., gamoutput &lt;- gam(salinity ~  s(doy, 
bs='cc')) is evaluated and the predicted values stored in the above data 
frame as <b>salinity.SAP.gam</b> and <b>salinity.BBP.gam</b>.  
</p>
<p>5) The GAM residuals, i.e., "residuals(gamoutput)" are extracted and stored
as the variable, <b>SAP</b> or <b>BBP</b> in the above data frame. 
(These are the values that are used for GAMs that include salinity.) 
</p>
<p>6) After the above data frame is created and appended to the 
list <b>salinity.detrended</b>, the following four (4) additional
data frames are created for each station.  
</p>
<p><b>mean</b> – For each doy (i.e., 366 days of year), the mean across all 
years for each value of d. Since samples are not collected on a daily basis
it is necessary to aggregate data from within a +/- one-half of
<b>dvAvgWinSel</b>-day window around d. (This includes wrapping around the
calendar year. That is, the values near the beginning of the year, say
January 2, would include values from the last part of December and the
first part of January. The variables in the mean data frame are doy, SAP, 
and BBP.   
</p>
<p><b>sd</b> – For each doy (i.e., 366 days of year), the standard deviation 
across all years for each value of d. (See mean calculations for additional
details.)    
</p>
<p><b>nobs</b> – For each doy (i.e., 366 days of year), the number of 
observations across all years for each value of d. (See mean calculations 
for additional details.)     
</p>
<p><b>lowess.sd</b> – Lowess smoothed standard deviations. It is noted that
some stations do not include regular sampling in all months of the year or
for other reasons have few observations from which to compute standard
deviations. Through visual inspection of plots, we found that the standard
deviation could become unstable when the number  of observations is small.
For this reason, when the number of observations is less than
<b>minObs.sd</b>, the corresponding value of lowess.sd is removed and
interpolated from the remaining observations.
</p>
<p>The above four data frames (mean, sd, nobs, and lowess.sd) are created, 
they are added to a list using a <b>station.sum</b> naming convention and 
appended to the list <b>salinity.detrended</b>.
</p>


<h3>Value</h3>

<p>Returns a list of seasonally detrended salinity data. You should save
the resulting list as salinity.detrended for use with baytrends.  This
function also creates diagnostic plots that can be saved to a report when
this function is called from an .Rmd script.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# Show Example Dataset (sal)
str(sal)

# Define Function Inputs
df.sal        &lt;- sal
dvAvgWinSel   &lt;- 30
lowess.f      &lt;- 0.2
minObs        &lt;- 40
minObs.sd    &lt;- 10
                 
# Run Function
salinity.detrended &lt;- detrended.salinity(df.sal, dvAvgWinSel, 
                                 lowess.f, minObs, minObs.sd) 

## End(Not run)              
</code></pre>


</div>