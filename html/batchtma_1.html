<div class="container">

<table style="width: 100%;"><tr>
<td>adjust_batch</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Adjust for batch effects</h2>

<h3>Description</h3>

<p><code>adjust_batch</code> generates biomarker levels for the variable(s)
<code>markers</code> in the dataset <code>data</code> that are corrected
(adjusted) for batch effects, i.e. differential measurement
error between levels of <code>batch</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">adjust_batch(
  data,
  markers,
  batch,
  method = c("simple", "standardize", "ipw", "quantreg", "quantnorm"),
  confounders = NULL,
  suffix = "_adjX",
  ipw_truncate = c(0.025, 0.975),
  quantreg_tau = c(0.25, 0.75),
  quantreg_method = "fn"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>Data set</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>markers</code></td>
<td>
<p>Variable name(s) to batch-adjust. Select
multiple variables with tidy evaluation, e.g.,
<code>markers = starts_with("biomarker")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>batch</code></td>
<td>
<p>Categorical variable indicating batch.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>Method for batch effect correction:
</p>

<ul>
<li> <p><code>simple</code>  Simple means per batch will be subtracted.
No adjustment for confounders.
</p>
</li>
<li> <p><code>standardize</code>  Means per batch after standardization
for confounders in linear models will be subtracted.
If no <code>confounders</code> are supplied, <code>method = simple</code>
is equivalent and will be used.
</p>
</li>
<li> <p><code>ipw</code>  Means per batch after inverse-probability
weighting for assignment to a specific batch in multinomial
models, conditional on confounders, will be subtracted.
Stabilized weights are used, truncated at quantiles
defined by the <code>ipw_truncate</code> parameters. If no
<code>confounders</code> are supplied, <code>method = simple</code>
is equivalent and will be used.
</p>
</li>
<li> <p><code>quantreg</code>  Lower quantiles (default: 25th percentile)
and ranges between a lower and an upper quantile (default: 75th
percentile) will be unified between batches, allowing for
differences in both parameters due to confounders. Set the two
quantiles using the <code>quantreg_tau</code> parameters.
</p>
</li>
<li> <p><code>quantnorm</code>  Quantile normalization between batches. No
adjustment for confounders.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>confounders</code></td>
<td>
<p>Optional: Confounders, i.e. determinants of
biomarker levels that differ between batches. Only used if
<code>method = standardize</code>, <code>method = ipw</code>, or
<code>method = quantreg</code>, i.e. methods that attempt to retain
some of these "true" between-batch differences. Select multiple
confounders with tidy evaluation, e.g.,
<code>confounders = c(age, age_squared, sex)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>suffix</code></td>
<td>
<p>Optional: What string to append to variable names
after batch adjustment. Defaults to <code>"_adjX"</code>, with
<code>X</code> depending on <code>method</code>:
</p>

<ul>
<li> <p><code>_adj2</code> from <code>method = simple</code>
</p>
</li>
<li> <p><code>_adj3</code> from <code>method = standardize</code>
</p>
</li>
<li> <p><code>_adj4</code> from <code>method = ipw</code>
</p>
</li>
<li> <p><code>_adj5</code> from <code>method = quantreg</code>
</p>
</li>
<li> <p><code>_adj6</code> from <code>method = quantnorm</code>
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ipw_truncate</code></td>
<td>
<p>Optional and used for <code>method = ipw</code> only:
Lower and upper quantiles for truncation of stabilized
weights. Defaults to <code>c(0.025, 0.975)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quantreg_tau</code></td>
<td>
<p>Optional and used for <code>method = quantreg</code> only:
Quantiles to scale. Defaults to <code>c(0.25, 0.75)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quantreg_method</code></td>
<td>
<p>Optional and used for <code>method = quantreg</code> only:
Algorithmic method to fit quantile regression. Defaults to
<code>"fn"</code>. See parameter <code>method</code> of <code>rq</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>If no true differences between batches are expected, because
samples have been randomized to batches, then a <code>method</code>
that returns adjusted values with equal means
(<code>method = simple</code>) or with equal rank values
(<code>method = quantnorm</code>) for all batches is appropriate.
</p>
<p>If the distribution of determinants of biomarker values
(<code>confounders</code>) differs between batches, then a
<code>method</code> that retains these "true" differences
between batches while adjusting for batch effects
may be appropriate: <code>method = standardize</code> and
<code>method = ipw</code> address means; <code>method = quantreg</code>
addresses lower values and dynamic range separately.
</p>
<p>Which <code>method</code> to choose depends on the properties of
batch effects (affecting means or also variance?) and
the presence and strength of confounding. For the two
mean-only confounder-adjusted methods, the choice may depend
on  whether the confounder–batch association (<code>method = ipw</code>)
or the confounder–biomarker association
(<code>method = standardize</code>) can be modeled better.
Generally, if batch effects are present, any adjustment
method tends to perform better than no adjustment in
reducing bias and increasing between-study reproducibility.
See references.
</p>
<p>All adjustment approaches except <code>method = quantnorm</code>
are based on linear models. It is recommended that variables
for <code>markers</code> and <code>confounders</code> first be transformed
as necessary (e.g., <code>log</code> transformations or
<code>splines</code>). Scaling or mean centering are not necessary,
and adjusted values are returned on the original scale.
Parameters <code>markers</code>, <code>batch</code>, and <code>confounders</code>
support tidy evaluation.
</p>
<p>Observations with missing values for the <code>markers</code> and
<code>confounders</code> will be ignored in the estimation of adjustment
parameters, as are empty batches. Batch effect-adjusted values
for observations with existing marker values but missing
confounders are based on adjustment parameters derived from the
other observations in a batch with non-missing confounders.
</p>


<h3>Value</h3>

<p>The <code>data</code> dataset with batch effect-adjusted
variable(s) added at the end. Model diagnostics, using
the attribute <code>.batchtma</code> of this dataset, are available
via the <code>diagnose_models</code> function.
</p>


<h3>Author(s)</h3>

<p>Konrad H. Stopsack
</p>


<h3>References</h3>

<p>Stopsack KH, Tyekucheva S, Wang M, Gerke TA, Vaselkiv JB, Penney KL,
Kantoff PW, Finn SP, Fiorentino M, Loda M, Lotan TL, Parmigiani G+,
Mucci LA+ (+ equal contribution). Extent, impact, and mitigation of
batch effects in tumor biomarker studies using tissue microarrays.
bioRxiv 2021.06.29.450369; doi: https://doi.org/10.1101/2021.06.29.450369
(This R package, all methods descriptions, and further recommendations.)
</p>
<p>Rosner B, Cook N, Portman R, Daniels S, Falkner B.
Determination of blood pressure percentiles in
normal-weight children: some methodological issues.
Am J Epidemiol 2008;167(6):653-66. (Basis for
<code>method = standardize</code>)
</p>
<p>Bolstad BM, Irizarry RA, Åstrand M, Speed TP.
A comparison of normalization methods for high density
oligonucleotide array data based on variance and bias.
Bioinformatics 2003;19:185–193. (<code>method = quantnorm</code>)
</p>


<h3>See Also</h3>

<p><a href="https://stopsack.github.io/batchtma/">https://stopsack.github.io/batchtma/</a>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Data frame with two batches
# Batch 2 has higher values of biomarker and confounder
df &lt;- data.frame(
  tma = rep(1:2, times = 10),
  biomarker = rep(1:2, times = 10) +
    runif(max = 5, n = 20),
  confounder = rep(0:1, times = 10) +
    runif(max = 10, n = 20)
)

# Adjust for batch effects
# Using simple means, ignoring the confounder:
adjust_batch(
  data = df,
  markers = biomarker,
  batch = tma,
  method = simple
)
# Returns data set with new variable "biomarker_adj2"

# Use quantile regression, include the confounder,
# change suffix of returned variable:
adjust_batch(
  data = df,
  markers = biomarker,
  batch = tma,
  method = quantreg,
  confounders = confounder,
  suffix = "_batchadjusted"
)
# Returns data set with new variable "biomarker_batchadjusted"
</code></pre>


</div>