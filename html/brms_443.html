<div class="container">

<table style="width: 100%;"><tr>
<td>threading</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Threading in Stan</h2>

<h3>Description</h3>

<p>Use threads for within-chain parallelization in <span class="pkg">Stan</span> via the <span class="pkg">brms</span>
interface. Within-chain parallelization is experimental! We recommend its use
only if you are experienced with Stan's <code>reduce_sum</code> function and have a
slow running model that cannot be sped up by any other means.
</p>


<h3>Usage</h3>

<pre><code class="language-R">threading(threads = NULL, grainsize = NULL, static = FALSE, force = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>threads</code></td>
<td>
<p>Number of threads to use in within-chain parallelization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>grainsize</code></td>
<td>
<p>Number of observations evaluated together in one chunk on
one of the CPUs used for threading. If <code>NULL</code> (the default),
<code>grainsize</code> is currently chosen as <code>max(100, N / (2 *
threads))</code>, where <code>N</code> is the number of observations in the data. This
default is experimental and may change in the future without prior notice.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>static</code></td>
<td>
<p>Logical. Apply the static (non-adaptive) version of
<code>reduce_sum</code>? Defaults to <code>FALSE</code>. Setting it to <code>TRUE</code>
is required to achieve exact reproducibility of the model results
(if the random seed is set as well).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>force</code></td>
<td>
<p>Logical. Defaults to <code>FALSE</code>. If <code>TRUE</code>, this will
force the Stan model to compile with threading enabled without altering the
Stan code generated by brms. This can be useful if your own custom Stan
functions use threading internally.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The adaptive scheduling procedure used by <code>reduce_sum</code> will
prevent the results to be exactly reproducible even if you set the random
seed. If you need exact reproducibility, you have to set argument
<code>static = TRUE</code> which may reduce efficiency a bit.
</p>
<p>To ensure that chunks (whose size is defined by <code>grainsize</code>) require
roughly the same amount of computing time, we recommend storing
observations in random order in the data. At least, please avoid sorting
observations after the response values. This is because the latter often
cause variations in the computing time of the pointwise log-likelihood,
which makes up a big part of the parallelized code.
</p>


<h3>Value</h3>

<p>A <code>brmsthreads</code> object which can be passed to the
<code>threads</code> argument of <code>brm</code> and related functions.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# this model just serves as an illustration
# threading may not actually speed things up here
fit &lt;- brm(count ~ zAge + zBase * Trt + (1|patient),
           data = epilepsy, family = negbinomial(),
           chains = 1, threads = threading(2, grainsize = 100),
           backend = "cmdstanr")
summary(fit)

## End(Not run)

</code></pre>


</div>