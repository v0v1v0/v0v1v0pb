<div class="container">

<table style="width: 100%;"><tr>
<td>bnec</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>bnec</h2>

<h3>Description</h3>

<p>Fits a variety of NEC models using Bayesian analysis and provides a model
averaged predictions based on WAIC model weights
</p>


<h3>Usage</h3>

<pre><code class="language-R">bnec(
  formula,
  data,
  x_range = NA,
  resolution = 1000,
  sig_val = 0.01,
  loo_controls,
  x_var = NULL,
  y_var = NULL,
  trials_var = NULL,
  model = NULL,
  random = NULL,
  random_vars = NULL,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>Either a <code>character</code> string defining an
R formula or an actual <code>formula</code> object. See
<code>bayesnecformula</code> and <code>check_formula</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A <code>data.frame</code> containing the data to use with
the <code>formula</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x_range</code></td>
<td>
<p>A range of predictor values over which to consider extracting
ECx.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>resolution</code></td>
<td>
<p>The length of the predictor vector used for posterior
predictions, and over which to extract ECx values. Large values will be
slower but more precise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sig_val</code></td>
<td>
<p>Probability value to use as the lower quantile to test
significance of the predicted posterior values against the lowest observed
concentration (assumed to be the control), to estimate NEC as an
interpolated NOEC value from smooth ECx curves.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loo_controls</code></td>
<td>
<p>A named <code>list</code> of two elements
("fitting" and/or "weights"), each being a named <code>list</code>
containing the desired arguments to be passed on to <code>loo</code>
(via "fitting") or to <code>loo_model_weights</code> (via "weights").
If "weights" is
not provided by the user, <code>bnec</code> will set the default
<code>method</code> argument in <code>loo_model_weights</code> to
"pseudobma". See ?<code>loo_model_weights</code> for further info.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x_var</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
<code>character</code> indicating the column heading
containing the predictor (concentration) variable.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y_var</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
<code>character</code> indicating the column heading
containing the response variable.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trials_var</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
<code>character</code> indicating the column
heading for the number of "trials" for binomial or "beta_binomial" response
data, as it appears in "data" (if data is supplied).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
<code>character</code> vector indicating the model(s)
to fit. See Details for more information.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>random</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
named <code>list</code> containing the random model
formula to apply to model parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>random_vars</code></td>
<td>
<p>Removed in version 2.0. Use formula instead. Used to be a
<code>character</code> vector containing the
names of the columns containing the variables used in the random model
formula.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Further arguments to <code>brm</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><b>Overview</b>
</p>
<p><code>bnec</code> serves as a wrapper for (currently) 23 (mostly) non-linear
equations that are classically applied to concentration(dose)-response
problems. The primary goal of these equations is to provide the user with
estimates of No-Effect-Concentration (NEC),
No-Significant-Effect-Concentration (NSEC), and Effect-Concentration
(of specified percentage 'x', <em>ECx</em>) thresholds.
These in turn are fitted through the <code>brm</code> function from
package <span class="pkg">brms</span> and therefore further arguments to <code>brm</code>
are allowed. In the absence of those arguments, <code>bnec</code> makes
its best attempt to calculate distribution family, priors and initialisation
values for the user based on the characteristics of the data. Moreover, in
the absence of user-specified values, <code>bnec</code> sets the number of
iterations to 1e4 and warmup period to <code>floor(iterations / 5) * 4</code>.
The chosen models can be extended by the addition of <span class="pkg">brms</span> special
"aterms" as well as group-level effects. See <code>?bayesnecformula</code>
for details.
</p>
<p><b>The available models/equations/formulas</b>
</p>
<p>The available equations (or models) can be found via the <code>models</code>
function. Since version 2.0, <code>bnec</code> requires a specific formula
structure
which is fully explained in the help file of <code>bayesnecformula</code>.
This formula incorporates the information regarding the chosen model(s). If
one single model is specified, <code>bnec</code> will return an object of
class <code>bayesnecfit</code>; otherwise if model is either a concatenation
of multiple models and/or a string indicating a family of models,
<code>bnec</code> will return an object of class
<code>bayesmanecfit</code>, providing they were successfully fitted. The
major difference being that the output of the latter includes Bayesian model
averaging statistics. These classes come with multiple associated
methods such as <code>plot</code>, <code>autoplot</code>,
<code>summary</code>, <code>print</code>,
<code>model.frame</code> and <code>formula</code>.
</p>
<p><code>model</code> may also be one of "all", meaning all of the available models
will be fit; "ecx" meaning only models excluding a specific NEC step
parameter will be fit; "nec" meaning only models with a specific NEC step
parameter will be fit; "bot_free" meaning only models without a "bot"
parameter (without a bottom plateau) will be fit; "zero_bounded" are models
that are bounded to be zero; or "decline" excludes all hormesis models, i.e.,
only allows a strict decline in response across the whole predictor range.
Notice that if one of these group strings is provided together with a
user-specified named list for the <code>brm</code>'s argument
<code>prior</code>, the list names need to contain
the actual model names, and not the group string , e.g. if
<code>model = "ecx"</code> and <code>prior = my_priors</code> then
<code>names(my_priors)</code> must contain <code>models("ecx")</code>. To check
available models and associated parameters for each group,
use the function <code>models</code> or to check the parameters of a
specific model use the function <code>show_params</code>.
</p>
<p><b>No-effect toxicity estimates</b>
</p>
<p>Regardless of the model(s) fitted, the resulting object will contain a
no-effect toxicity estimate. Where the fitted model(s) are NEC models (threshold
models, containing a step function - all models with "nec" as a
prefix) the no-effect estimate is a true
no-effect-concentration (NEC, see Fox 2010). Where the fitted model(s) are
smooth ECx models with no step function (all models with "ecx" as a
prefix), the no-effect estimate is a no-significant-effect-concentration
(NSEC, see Fisher and Fox 2023).
In the case of a <code>bayesmanecfit</code> that contains a mixture of both
NEC and ECx models, the no-effect estimate is a model averaged combination of
the NEC and NSEC estimates, and is reported as the N(S)EC
(see Fisher et al. 2023).
</p>
<p><b>Further argument to <code>brm</code></b>
</p>
<p>If not supplied via the <code>brm</code> argument <code>family</code>, the
appropriate distribution will be guessed based on the characteristics of the
input data. Guesses include: "bernoulli" / bernoulli / bernoulli(), "Beta" /
Beta / Beta(), "binomial" / binomial / binomial(), "beta_binomial" /
"beta_binomial", "Gamma" / Gamma / Gamma(), "gaussian" / gaussian /
gaussian(), "negbinomial" / negbinomial / negbinomial(), or "poisson" /
poisson / poisson(). Note, however, that "negbinomial" and "betabinomimal2"
require knowledge on whether the data is over-dispersed. As
explained below in the Return section, the user can extract the dispersion
parameter from a <code>bnec</code> call, and if they so wish, can refit the
model using the "negbinomial" family.
</p>
<p>Other families can be considered as required, please raise an
<a href="https://github.com/open-AIMS/bayesnec/issues">issue</a> on the GitHub
development site if your required family is not currently available.
</p>
<p>As a default, <code>bnec</code> sets the <code>brm</code> argument
<code>sample_prior</code> to "yes" in order to sample draws from the priors in
addition to the posterior distributions. Among others, these samples can be
used to calculate Bayes factors for point hypotheses via
<code>hypothesis</code>.
</p>
<p>Model averaging is achieved through a weighted sample of each fitted models
posterior predictions, with weights derived using functions
<code>loo</code> and <code>loo_model_weights</code> from
<span class="pkg">brms</span>. Argument to both these functions can be passed via the
<code>loo_controls</code> argument. Individual model fits can be pulled out
for examination using function <code>pull_out</code>.
</p>
<p><b>Additional technical notes</b>
</p>
<p>As some concentration-response data will use zero concentration
which can cause numerical estimation issues, a small offset is added (1 /
10th of the next lowest value) to zero values of concentration where
<code>x_var</code> are distributed on a continuous scale from 0 to infinity, or
are bounded to 0, or 1.
</p>
<p><b>NAs are thrown away</b>
</p>
<p>Stan's default behaviour is to fail when the input data contains NAs. For
that reason <span class="pkg">brms</span> excludes any NAs from input data prior to fitting,
and does not allow them back in as is the case with e.g. <code>stats::lm</code> and
<code>na.action = exclude</code>. So we advise that you exclude any NAs in your
data prior to fitting because if you so wish that should facilitate merging
predictions back onto your original dataset.
</p>


<h3>Value</h3>

<p>If argument model is a single string, then an object of class
<code>bayesnecfit</code>; if many strings or a set,
an object of class <code>bayesmanecfit</code>.
</p>


<h3>References</h3>

<p>Fisher R, Barneche DR, Ricardo GF, Fox, DR (2024) An R Package for
Concentration-Response Modeling and Estimation of Toxicity Metrics
doi:10.18637/jss.v110.i05.
</p>
<p>Fisher R, Fox DR (2023). Introducing the no significant effect concentration
(NSEC).Environmental Toxicology and Chemistry, 42(9), 2019–2028.
doi: 10.1002/etc.5610.
</p>
<p>Fisher R, Fox DR, Negri AP, van Dam J, Flores F, Koppel D (2023). Methods for
estimating no-effect toxicity concentrations in ecotoxicology. Integrated
Environmental Assessment and Management. doi:10.1002/ieam.4809.
</p>
<p>Fox DR (2010). A Bayesian Approach for Determining the No Effect
Concentration and Hazardous Concentration in Ecotoxicology. Ecotoxicology
and Environmental Safety, 73(2), 123–131. doi: 10.1016/j.ecoenv.2009.09.012.
</p>


<h3>See Also</h3>

<p><code>bayesnecformula</code>,
<code>check_formula</code>,
<code>models</code>,
<code>show_params</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
library(bayesnec)
data(nec_data)

# A single model
exmp_a &lt;- bnec(y ~ crf(x, model = "nec4param"), data = nec_data, chains = 2)
# Two models model
exmp_b &lt;- bnec(y ~ crf(x, model = c("nec4param", "ecx4param")),
               data = nec_data, chains = 2)

## End(Not run)

</code></pre>


</div>