<div class="container">

<table style="width: 100%;"><tr>
<td>apply_mistnet</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Apply MistNet segmentation to a polar volume</h2>

<h3>Description</h3>

<p>Applies the MistNet segmentation model to a polar volume file on disk and
loads the resultant segmentation as a polar volume (<code>pvol</code>) object.
</p>


<h3>Usage</h3>

<pre><code class="language-R">apply_mistnet(
  file,
  pvolfile_out,
  verbose = FALSE,
  mount = dirname(file),
  load = TRUE,
  mistnet_elevations = c(0.5, 1.5, 2.5, 3.5, 4.5),
  local_install,
  local_mistnet
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>file</code></td>
<td>
<p>Character. Path to a polar volume (<code>pvol</code>) file.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pvolfile_out</code></td>
<td>
<p>Character. (optional) File name. When provided, writes a
polar volume (<code>pvol</code>) file to disk that includes the Mistnet segmentation
results.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Logical. When <code>TRUE</code>, vol2bird <code>stdout</code> is piped to the R
console.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mount</code></td>
<td>
<p>Character. Directory path of the mount point for the Docker
container (deprecated).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>load</code></td>
<td>
<p>Logical. When <code>TRUE</code>, returns a <code>pvol</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mistnet_elevations</code></td>
<td>
<p>Numeric vector of length 5. Elevation angles to
feed to the MistNet segmentation model, which expects exactly 5 elevation
scans at 0.5, 1.5, 2.5, 3.5 and 4.5 degrees. Specifying different elevation
angles may compromise segmentation results.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>local_install</code></td>
<td>
<p>Character. Path to local vol2bird installation (e.g.
<code>your/vol2bird_install_directory/vol2bird/bin/vol2bird</code>) to use instead of
the Docker container.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>local_mistnet</code></td>
<td>
<p>Character. Path to local MistNet segmentation model in
PyTorch format (e.g. <code style="white-space: pre;">⁠/your/path/mistnet_nexrad.pt⁠</code>) to use instead of the
Docker container.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>MistNet (Lin et al. 2019) is a deep convolutional neural network that has
been trained using labels derived from S-band dual-polarization data across
the US NEXRAD network. Its purpose is to screen out areas of precipitation in
weather radar data, primarily legacy data for which dual-polarization data
are not available. Because the network has been trained on S-band data, it
may not perform as well on C-band.
</p>
<p>MistNet requires three single-polarization parameters as input: reflectivity
(<code>DBZH</code>), radial velocity (<code>VRADH</code>), and spectrum width (<code>WRADH</code>), at 5
specific elevation angles (0.5, 1.5, 2.5, 3.5 and 4.5 degrees). Based on
these data it can estimate a segmentation mask that identifies pixels with
weather that should be removed when interested in biological data only.
</p>
<p>MistNet will calculate three class probabilities (from 0 to 1, with 1
corresponding to a 100% probability) as additional scan parameters to the
polar volume:
</p>

<ul>
<li> <p><code>BACKGROUND</code>: Class probability that no signal was detected above the noise
level of the radar.
</p>
</li>
<li> <p><code>WEATHER</code>: Class probability that weather was detected.
</p>
</li>
<li> <p><code>BIOLOGY</code>: Class probability that biological scatterers were detected.
</p>
</li>
</ul>
<p>MistNet will calculate three class probabilities (from 0 to 1, with 1 corresponding
to a 100% probability) as additional scan parameters to the polar volume:
</p>

<ul>
<li> <p><code>BACKGROUND</code>: Class probability that no signal was detected above the noise
level of the radar
</p>
</li>
<li> <p><code>WEATHER</code>: Class probability that weather was detected
</p>
</li>
<li> <p><code>BIOLOGY</code>: Class probability that biological scatterers were detected
</p>
</li>
</ul>
<p>These class probabilities are only available for the 5 input elevations used
as input for the MistNet model. Based on all the class probabilities a final
weather segmentation map is calculated, stored as scan parameter <code>CELL</code>,
which is available for all elevation scans.
</p>

<ul><li> <p><code>CELL</code>: Final weather segmentation, with values &gt; 1 indicating pixels
classified as weather and values equal to 1 indicating pixels that are
located within 5 km distance of a weather pixels.
</p>
</li></ul>
<p>A pixel is classified as weather if the class probability <code>WEATHER</code> &gt; 0.45 or
when the average class probability for rain across all five MistNet elevation
scans at that spatial location &gt; 0.45.
</p>
<p>MistNet may run more slowly on Windows than on Linux or Mac OS X.
</p>


<h3>Value</h3>

<p>When <code>load</code> is <code>TRUE</code>, a polar volume (<code>pvol</code>) object with the
Mistnet segmentation results. When <code>load</code> is <code>FALSE</code>, <code>TRUE</code> on success.
</p>


<h3>References</h3>

<p>Please cite this publication when using MistNet:
</p>

<ul><li>
<p> Lin T-Y, Winner K, Bernstein G, Mittal A, Dokter AM, Horton KG, Nilsson C,
Van Doren BM, Farnsworth A, La Sorte FA, Maji S, Sheldon D (2019) MistNet:
Measuring historical bird migration in the US using archived weather radar
data and convolutional neural networks. Methods in Ecology and Evolution 10
(11), pp. 1908-22. <a href="https://doi.org/10.1111/2041-210X.13280">doi:10.1111/2041-210X.13280</a>
</p>
</li></ul>
<h3>See Also</h3>


<ul>
<li> <p><code>check_docker()</code>
</p>
</li>
<li> <p><code>calculate_vp()</code>
</p>
</li>
</ul>
<h3>Examples</h3>

<pre><code class="language-R">
# make sure you have installed the MistNet libraries and model, using:
if (requireNamespace("vol2birdR", quietly = TRUE)){
if(!vol2birdR::mistnet_exists()){
   vol2birdR::install_mistnet()
   vol2birdR::install_mistnet_model()
}
# start a temporary file to store polar volume
tempfile=tempfile("KBGM_example")
# Download a NEXRAD file and save as KBGM_example
download.file(
  "https://noaa-nexrad-level2.s3.amazonaws.com/2019/10/01/KBGM/KBGM20191001_000542_V06",
  method="libcurl", mode="wb", tempfile
)

# Calculate MistNet segmentation
mistnet_pvol &lt;- apply_mistnet(tempfile)

# Print summary info for the segmented elevation scan at the 0.5 degree,
# verify new parameters BIOLOGY, WEATHER, BACKGROUND and CELL have been added
scan &lt;- get_scan(mistnet_pvol, 0.5)
scan

# Project the scan as a ppi
ppi &lt;- project_as_ppi(scan, range_max = 100000)

# Plot the reflectivity parameter
plot(ppi, param = "DBZH")

# Plot the MistNet class probability [0-1] for weather
plot(ppi, param = "WEATHER")

# Plot the MistNet class probability [0-1] for biology
plot(ppi, param = "BIOLOGY")

# Plot the final segmentation result, with values &gt;1 indicating
# areas classified as weather, and value 1 pixels that fall within an
# additional 5 km fringe around weather areas
plot(ppi, param = "CELL")

# Remove file
file.remove(tempfile)
}

</code></pre>


</div>