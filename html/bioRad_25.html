<div class="container">

<table style="width: 100%;"><tr>
<td>calculate_vp</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calculate a vertical profile (<code>vp</code>) from a polar volume (<code>pvol</code>) file</h2>

<h3>Description</h3>

<p>Calculates a vertical profile of biological scatterers (<code>vp</code>) from a polar
volume (<code>pvol</code>) file using the algorithm
<a href="https://github.com/adokter/vol2bird/">vol2bird</a> (Dokter et al.
2011 <a href="https://doi.org/10.1098/rsif.2010.0116">doi:10.1098/rsif.2010.0116</a>).
</p>


<h3>Usage</h3>

<pre><code class="language-R">calculate_vp(
  file,
  vpfile = "",
  pvolfile_out = "",
  autoconf = FALSE,
  verbose = FALSE,
  warnings = TRUE,
  mount,
  sd_vvp_threshold,
  rcs = 11,
  dual_pol = TRUE,
  rho_hv = 0.95,
  single_pol = TRUE,
  elev_min = 0,
  elev_max = 90,
  azim_min = 0,
  azim_max = 360,
  range_min = 5000,
  range_max = 35000,
  n_layer = 20,
  h_layer = 200,
  dealias = TRUE,
  nyquist_min = if (dealias) 5 else 25,
  dbz_quantity = "DBZH",
  mistnet = FALSE,
  mistnet_elevations = c(0.5, 1.5, 2.5, 3.5, 4.5),
  local_install,
  local_mistnet
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>file</code></td>
<td>
<p>Character (vector). Either a path to a single radar polar volume
(<code>pvol</code>) file containing multiple scans/sweeps, or multiple paths to scan
files containing a single scan/sweep. Or a single <code>pvol</code> object. The file data format should be either 1)
<a href="https://github.com/adokter/vol2bird/blob/master/doc/OPERA2014_O4_ODIM_H5-v2.2.pdf">ODIM</a>
format, which is the implementation of the OPERA data information model in
the <a href="https://support.hdfgroup.org/HDF5/">HDF5</a> format, 2) a format
supported by the <a href="https://trmm-fc.gsfc.nasa.gov/trmm_gv/software/rsl/">RSL library</a> or 3) Vaisala
IRIS (IRIS RAW) format.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vpfile</code></td>
<td>
<p>Character. File name. When provided, writes a vertical profile
file (<code>vpfile</code>) either in the VPTS CSV or ODIM HDF5 format to disk.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pvolfile_out</code></td>
<td>
<p>Character. File name. When provided, writes a polar
volume (<code>pvol</code>) file in the ODIM HDF5 format to disk. Useful for converting
RSL formats to ODIM.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>autoconf</code></td>
<td>
<p>Logical. When <code>TRUE</code>, default optimal configuration settings
are selected automatically and other user settings are ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Logical. When <code>TRUE</code>, vol2bird <code>stdout</code> is piped to the R
console.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warnings</code></td>
<td>
<p>Logical. When <code>TRUE</code>, vol2bird warnings are piped to the R
console.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mount</code></td>
<td>
<p>Character. Directory path of the mount point for the Docker
container (deprecated).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sd_vvp_threshold</code></td>
<td>
<p>Numeric. Lower threshold for the radial velocity
standard deviation (profile quantity <code>sd_vvp</code>) in m/s. Biological signals
with <code>sd_vvp &lt; sd_vvp_threshold</code> are set to zero. Defaults to 2 m/s for
C-band radars and 1 m/s for S-band radars.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rcs</code></td>
<td>
<p>Numeric. Radar cross section per bird to use, in cm^2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dual_pol</code></td>
<td>
<p>Logical. When <code>TRUE</code>, uses dual-pol mode, in which
meteorological echoes are filtered using the correlation coefficient
threshold <code>rho_hv</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rho_hv</code></td>
<td>
<p>Numeric. Lower threshold in correlation coefficient to use for
filtering meteorological scattering.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>single_pol</code></td>
<td>
<p>Logical. When <code>TRUE</code>, uses precipitation filtering in single
polarization mode based on reflectivity and radial velocity quantities.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>elev_min</code></td>
<td>
<p>Numeric. Minimum elevation angle to include, in degrees.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>elev_max</code></td>
<td>
<p>Numeric. Maximum elevation angle to include, in degrees.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>azim_min</code></td>
<td>
<p>Numeric. Minimum azimuth to include, in degrees clockwise
from north.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>azim_max</code></td>
<td>
<p>Numeric. Maximum azimuth to include, in degrees clockwise
from north.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>range_min</code></td>
<td>
<p>Numeric. Minimum range to include, in m.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>range_max</code></td>
<td>
<p>Numeric. Maximum range to include, in m.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n_layer</code></td>
<td>
<p>Numeric. Number of altitude layers to use in generated
profile.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>h_layer</code></td>
<td>
<p>Numeric. Width of altitude layers to use in generated profile,
in m.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dealias</code></td>
<td>
<p>Logical. Whether to dealias radial velocities. This should
typically be done when the scans in the polar volume have low Nyquist
velocities (below 25 m/s).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nyquist_min</code></td>
<td>
<p>Numeric. Minimum Nyquist velocity of scans to include, in
m/s.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dbz_quantity</code></td>
<td>
<p>Name of the available reflectivity factor to use if not
<code>DBZH</code> (e.g. <code>DBZV</code>, <code>TH</code>, <code>TV</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mistnet</code></td>
<td>
<p>Logical. Whether to use the MistNet segmentation model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mistnet_elevations</code></td>
<td>
<p>Numeric vector of length 5. Elevation angles to
feed to the MistNet segmentation model, which expects exactly 5 elevation
scans at 0.5, 1.5, 2.5, 3.5 and 4.5 degrees. Specifying different elevation
angles may compromise segmentation results.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>local_install</code></td>
<td>
<p>Character. Path to local vol2bird installation (e.g.
<code>your/vol2bird_install_directory/vol2bird/bin/vol2bird.sh</code>). (deprecated)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>local_mistnet</code></td>
<td>
<p>Character. Path to local MistNet segmentation model in
PyTorch format (e.g. <code style="white-space: pre;">⁠/your/path/mistnet_nexrad.pt⁠</code>).</p>
</td>
</tr>
</table>
<h3>Details</h3>



<h4>Typical use</h4>

<p>Common arguments set by users are <code>file</code>, <code>vpfile</code> and <code>autoconf</code>.
Turn on <code>autoconf</code> to automatically select the optimal parameters for a given
radar file. The default for C-band data is to apply rain-filtering in single
polarization mode and dual polarization mode when available. The default for
S-band data is to apply precipitation filtering in dual-polarization mode
only.
</p>
<p>Arguments that sometimes require non-default values are: <code>rcs</code>,
<code>sd_vvp_threshold</code>, <code>range_max</code>, <code>dual_pol</code>, <code>dealias</code>. Other arguments are
typically left at their defaults.
</p>



<h4>sd_vvp_threshold</h4>

<p>For altitude layers with a VVP-retrieved radial velocity standard deviation
value below the threshold <code>sd_vvp_threshold</code>, the bird density <code>dens</code> is set
to zero (see vertical profile <code>vp</code> class). This threshold
might be dependent on radar processing settings. Results from validation
campaigns so far indicate that 2 m/s is the best choice for this parameter
for most C-band weather radars, which is used as the C-band default. For
S-band, the default threshold is 1 m/s.
</p>



<h4>rcs</h4>

<p>The default radar cross section (<code>rcs</code>) (11 cm^2) corresponds to the average
value found by Dokter et al. (2011) in a calibration campaign of a full
migration autumn season in western Europe at C-band. Its value may depend on
radar wavelength. <code>rcs</code> will scale approximately <code class="reqn">M^{2/3}</code> with <code>M</code> the
bird's mass.
</p>



<h4>dual_pol</h4>

<p>For S-band (radar wavelength ~ 10 cm), currently only <code>dual_pol = TRUE</code> mode
is recommended.
</p>



<h4>azim_min / azim_max</h4>

<p><code>azim_min</code> and <code>azim_max</code> only affects reflectivity-derived estimates in the
profile (<code>DBZH</code>, <code>eta</code>, <code>dens</code>), not radial-velocity derived estimates (<code>u</code>,
<code>v</code>, <code>w</code>, <code>ff</code>, <code>dd</code>, <code>sd_vvp</code>), which are estimated on all azimuths at all
times. <code>azim_min</code>, <code>azim_max</code> may be set to exclude an angular sector with
high ground clutter.
</p>



<h4>range_min / range_max</h4>

<p>Using default values of <code>range_min</code> and <code>range_max</code> is recommended. Ranges
closer than 5 km tend to be contaminated by ground clutter, while range gates
beyond 35 km become too wide to resolve the default altitude layer width of
200 meter (see <code>beam_width()</code>). <code>range_max</code> may be extended up to 40 km
(<code>40000</code>) for volumes with low elevations only, in order to extend coverage
to higher altitudes.
</p>



<h4>h_layer</h4>

<p>The algorithm has been tested and developed for altitude layers with <code>h_layer = 200</code>m. Smaller widths than 100 m are not recommended as they may cause
instabilities of the volume velocity profiling (VVP) and dealiasing routines,
and effectively lead to pseudo-replicated altitude data, since altitudinal
patterns smaller than the beam width cannot be resolved.
</p>



<h4>dealias</h4>

<p>Dealiasing uses the torus mapping method by Haase et al. (2004).
</p>



<h4>Local installation</h4>

<p>You may point parameter <code>local_mistnet</code> to a local download of the MistNet segmentation model in
PyTorch format, e.g. <code style="white-space: pre;">⁠/your/path/mistnet_nexrad.pt⁠</code>. The MistNet model can
be downloaded at <a href="https://s3.amazonaws.com/mistnet/mistnet_nexrad.pt">https://s3.amazonaws.com/mistnet/mistnet_nexrad.pt</a>.
</p>



<h3>Value</h3>

<p>A vertical profile object of class <code>vp</code>. When defined, output files
<code>vpfile</code> and <code>pvolfile_out</code> are saved to disk.
</p>


<h3>References</h3>

<p>Dokter et al. (2011) is the main reference for the profiling algorithm
(vol2bird) underlying this function. When using the <code>mistnet</code> option, please
also cite Lin et al. (2019). When dealiasing data (<code>dealias</code>), please also
cite Haase et al. (2004).
</p>

<ul>
<li>
<p> Dokter AM, Liechti F, Stark H, Delobbe L,Tabary P, Holleman I (2011) Bird
migration flight altitudes studied by a network of operational weather
radars, Journal of the Royal Society Interface 8 (54), pp. 30-43.
<a href="https://doi.org/10.1098/rsif.2010.0116">doi:10.1098/rsif.2010.0116</a>
</p>
</li>
<li>
<p> Haase G &amp; Landelius T (2004)
Dealiasing of Doppler radar velocities using a torus mapping. Journal of
Atmospheric and Oceanic Technology 21(10), pp. 1566-1573.
<a href="https://doi.org/10.1175/1520-0426%282004%29021%3C1566%3ADODRVU%3E2.0.CO%3B2">doi:10.1175/1520-0426(2004)021&lt;1566:DODRVU&gt;2.0.CO;2</a>
</p>
</li>
<li>
<p> Lin T-Y, Winner K, Bernstein G, Mittal A, Dokter AM, Horton KG, Nilsson C,
Van Doren BM, Farnsworth A, La Sorte FA, Maji S, Sheldon D (2019) MistNet:
Measuring historical bird migration in the US using archived weather radar
data and convolutional neural networks. Methods in Ecology and Evolution 10
(11), pp. 1908-22. <a href="https://doi.org/10.1111/2041-210X.13280">doi:10.1111/2041-210X.13280</a>
</p>
</li>
</ul>
<h3>See Also</h3>


<ul>
<li> <p><code>summary.pvol()</code>
</p>
</li>
<li> <p><code>summary.vp()</code>
</p>
</li>
</ul>
<h3>Examples</h3>

<pre><code class="language-R"># Locate and read the polar volume example file
pvolfile_source &lt;- system.file("extdata", "volume.h5", package = "bioRad")

# Copy the file to a temporary directory with read/write permissions
pvolfile &lt;- paste0(tempdir(),"/volume.h5")
file.copy(pvolfile_source, pvolfile)

# Calculate the profile
if (requireNamespace("vol2birdR", quietly = TRUE)) {
vp &lt;- calculate_vp(pvolfile)

# Get summary info
vp

# Clean up
file.remove(pvolfile)

}

</code></pre>


</div>