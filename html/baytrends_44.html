<div class="container">

<table style="width: 100%;"><tr>
<td>detrended.flow</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create Seasonally Detrended Flow Data Set</h2>

<h3>Description</h3>

<p>This function creates a seasonally detrended flow data set for
selected USGS gages. The created data set is used to support application of
GAMs that include a hydrologic term as one of the independent variables.
The output from this function should be stored as an .rda file for repeated
use with baytrends.
</p>


<h3>Usage</h3>

<pre><code class="language-R">detrended.flow(
  usgsGageID,
  siteName,
  yearStart,
  yearEnd,
  dvAvgWinSel = c(1, 5, 10, 15, 20, 30, 40, 50, 60, 90, 120, 150, 180, 210),
  dvAvgWgtSel = "uniform",
  dvAvgSidesSel = 1,
  lowess.f = 0.2,
  span = 10,
  max.fill = 10
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>usgsGageID</code></td>
<td>
<p>USGS GageIDs (e.g., "01491000")</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>siteName</code></td>
<td>
<p>USGS SiteName (only used for plots)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yearStart</code></td>
<td>
<p>start year (recommended as at least one year before
corresponding water quality data set)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yearEnd</code></td>
<td>
<p>end year</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dvAvgWinSel</code></td>
<td>
<p>Averaging window (days) for smoothing the residuals of the
seasonally adjusted daily flow values 
[default = c(1, 5, 10, 15, 20, 30, 40, 50, 60, 90, 120, 150, 180, 210)]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dvAvgWgtSel</code></td>
<td>
<p>Averaging method ("uniform", "weighted", or "centered")
for creating weights. If using "weighted" then use dvAvgSidesSel=1.  If
using "centered" then use dvAvgSidesSel=2. [default = "uniform"]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dvAvgSidesSel</code></td>
<td>
<p>If dvAvgSidesSel=1 only past values are used, if
dvAvgSidesSel=2 then values are centered around lag 0. [default = 1]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lowess.f</code></td>
<td>
<p>lowess smoother span applied to computed standard deviation
(see Details). This gives the proportion of points which influence the
smooth at each value. Larger values give more smoothness. [default = 0.2]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>span</code></td>
<td>
<p>maximum number of observations on each side of range of missing
values to use in filling in data [default = 10]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max.fill</code></td>
<td>
<p>maximum gap to fill in [default = 10]</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function returns a list of seasonally detrended flow and 
companion statistics; and relies on USGS' dataRetrieval package to retrieve
daily flow data.   
</p>
<p>It is the user responsibility to save the resulting list as 
<b>flow.detrended</b> for integration with baytrends.  
</p>
<p>For the purposes of baytrends, it is expected that the user 
would identify all USGS gages that are expected to be evaluated so that a 
single data file is created. To best match up with water quality data, we 
recommend retrieving flow data for one year prior to the first year of 
water quality data. This allows for creating a time-averaged flow data set 
and not loose the first few months of water quality data due to lack of 
matching flow data. Data retrievals should also be made in light of the 
time needed by the USGS to review and approve their flow records.
</p>
<p>After retrieval, the following computation steps are performed to create a
data frame for each USGS gage (the data frame naming convention is
<b>qNNNNNNNN</b> where NNNNNNNN is the USGS gage ID):   
</p>
<p>1) The daily flow data are converted to cubic meters per second [cms] and
stored as the variable <b>q</b>.  
</p>
<p>2) The day of year (<b>doy</b>) is added to the data set. We use a 366 day
calendar regardless of leap year.      
</p>
<p>3) The Log (ln) flow is computed and stored as <b>LogQ</b>.    
</p>
<p>4) A seasonal GAM, i.e., gamoutput &lt;- gam(LogQ ~  s(doy, bs='cc')) is
evaluated and the predicted values stored as <b>qNNNNNNNN.gam</b>.  
</p>
<p>5) The GAM residuals, i.e., "residuals(gamoutput)" are extracted and stored
as the variable, <b>d1</b>.  
</p>
<p>6) Based on the specifications for dvAvgWinSel, dvAvgWgtSel, and
dvAvgSidesSel, the values of <b>d1</b> are time averaged and additional
variables <b>dxxx</b> are added to the data frame where xxx corresponds to
list of averaging windows specified in dvAvgWinSel. These values of
<b>dxxx</b> are used in GAMs that include a hydrologic independent
variable.
</p>
<p>After the above data frame is created, the following four (4) additional
data frames are created for each USGS gage and combined into a list named
<b>qNNNNNNNN.sum</b>:   
</p>
<p><b>mean</b> – For each doy (i.e., 366 days of year), the mean across all
years for each value of d in the above data frame, qNNNNNNNN.   
</p>
<p><b>sd</b> – For each doy (i.e., 366 days of year), the standard deviation 
across all years for each value of d in the above data frame, qNNNNNNNN.  
</p>
<p><b>nobs</b> – For each doy (i.e., 366 days of year), the number of 
observations across all years for each value of d in the above data frame
, qNNNNNNNN.  
</p>
<p><b>lowess.sd</b> – Lowess smoothed standard deviations. (These values are
used for computing confidence intervals in the flow averaged GAM.)  
</p>
<p>The process of creating the above data frame, <b>qNNNNNNNN</b>, and list,
<b>qNNNNNNNN.sum</b>, is repeated for each USGS gage and combined together
in a single list. The beginning of the list includes meta data documenting
the retrieval parameters.
</p>
<p>This function can be used in conjunction with an RMD file to knit (create)
a report (DOCX or HTML).
</p>


<h3>Value</h3>

<p>Returns a list of seasonally detrended flow data. You should save the
resulting list as flow.detrended for use with baytrends.  This function
also creates diagnostic plots that can be saved to a report when this
function is called from an .Rmd script.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# Define Function Inputs
usgsGageID    &lt;- c("01491000", "01578310")
siteName      &lt;- c("Choptank River near Greensboro, MD",
                   "Susquehanna River at Conowingo, MD")
yearStart     &lt;- 1983
yearEnd       &lt;- 2016
dvAvgWinSel   &lt;- c(1, 5, 10, 15, 20, 30, 40, 50, 60, 90, 120, 150, 180, 210)
dvAvgWgtSel   &lt;- "uniform"
dvAvgSidesSel &lt;- 1
lowess.f      &lt;- 0.2
                 
# Run Function
flow.detrended &lt;- detrended.flow(usgsGageID, siteName, yearStart, yearEnd
                                , dvAvgWinSel, dvAvgWgtSel, dvAvgSidesSel
                               , lowess.f)

## End(Not run)
</code></pre>


</div>