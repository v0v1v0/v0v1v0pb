<div class="container">

<table style="width: 100%;"><tr>
<td>bartc</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Causal Inference using Bayesian Additive Regression Trees</h2>

<h3>Description</h3>

<p>Fits a collection of treatment and response models using the Bayesian Additive
Regression Trees (BART) algorithm, producing estimates of treatment effects.
</p>


<h3>Usage</h3>

<pre><code class="language-R">bartc(response, treatment, confounders, parametric, data, subset, weights,
      method.rsp = c("bart", "tmle", "p.weight"),
      method.trt = c("bart", "glm", "none"),
      estimand   = c("ate", "att", "atc"),
      group.by = NULL,
      commonSup.rule = c("none", "sd", "chisq"),
      commonSup.cut  = c(NA_real_, 1, 0.05),
      args.rsp = list(), args.trt = list(),
      p.scoreAsCovariate = TRUE, use.ranef = TRUE, group.effects = FALSE,
      crossvalidate = FALSE,
      keepCall = TRUE, verbose = TRUE,
      seed = NA_integer_,
      ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>response</code></td>
<td>

<p>A vector of the outcome variable, or a reference to such in the <code>data</code>
argument. Can be continuous or binary.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treatment</code></td>
<td>

<p>A vector of the binary treatment variable, or a reference to <code>data</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>confounders</code></td>
<td>

<p>A matrix or data frame of covariates to be used in estimating the treatment
and response model. Can also be the right-hand-side of a formula (e.g.
<code>x1 + x2 + ...</code>). The <code>data</code> argument will be searched if
supplied.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parametric</code></td>
<td>

<p>The right-hand-side of a formula (e.g. <code>x1 + x2 + (1 | g) ...</code>) giving the
equation of a parametric form to be used for estimating the mean structure.
See the details section below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>

<p>An optional data frame or named list containing the <code>response</code>,
<code>treatment</code>, and <code>confounders</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>

<p>An optional vector using to subset the data. Can refer to <code>data</code> if
provided.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>

<p>An optional vector of population weights used in model fitting and
estimating the treatment effect. Can refer to <code>data</code> if provided.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method.rsp</code></td>
<td>

<p>A character string specifying which method to use when fitting the response
surface and estimating the treatment effect. Options are: <code>"bart"</code> -
fit the response surface with BART and take the average of the individual
treatment effect estimates, <code>"p.weight"</code> - fit the response surface
with BART but compute the treatment effect estimate by using a propensity
score weighted sum of individual effects, and <code>"tmle"</code> - as above, but
further adjust the individual estimates using the Targeted Minimum Loss
based Estimation (TMLE) adjustment.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method.trt</code></td>
<td>

<p>A character string specifying which method to use when fitting the treatment
assignment mechanism, or a vector/matrix of propensity scores. Character
string options are: <code>"bart"</code> - fit BART directly to the treatment
variable, <code>"glm"</code> - fit a generalized linear model with a binomial
response and all confounders added linearly, and <code>"none"</code> - do no
propensity score estimation. Cannot be <code>"none"</code> if the response model
requires propensity scores. When supplied as a matrix, it should be of
dimensions equal to the number of observations times the number of samples
used in any response model.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estimand</code></td>
<td>

<p>A character string specifying which causal effect to target. Options are
<code>"ate"</code> - average treatment effect, <code>"att"</code> - average treatment
effect on the treated, and <code>"atc"</code> - average treatment effect on the
controls.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group.by</code></td>
<td>

<p>An optional factor that, when present, causes the treatment effect estimate
to be calculated within each group.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>commonSup.rule</code></td>
<td>

<p>Rule for exclusion of observations lacking in common support. Options are
<code>"none"</code> - no suppression, <code>"sd"</code> - exclude units whose predicted
counterfactual standard deviation is extreme compared to the maximum
standard deviation under those units' observed treatment condition, where
extreme refers to the distribution of all standard deviations of observed
treatment conditions, <code>"chisq"</code> - exclude observations according to
ratio of the variance of posterior predicted counterfactual to the posterior
variance of the observed condition, having a Chi Squared distribution with
one degree of freedom under the null hypothesis of have equal distributions.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>commonSup.cut</code></td>
<td>

<p>Cutoffs for <code>commonSup.rule</code>. Ignored for <code>"none"</code>, when
<code>commonSup.rule</code> is <code>"sd"</code>, refers to how many standard deviations
of the distribution of posterior variance for counterfactuals an observation
can be above the maximum of posterior variances for that treatment
condition. When <code>commonSup.rule</code> is <code>"chisq"</code>, is the <code class="reqn">p</code>
value used for rejection of the hypothesis of equal variances.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p.scoreAsCovariate</code></td>
<td>

<p>A logical such that when <code>TRUE</code>, the propensity score is added to the
response model as a covariate. When used, this is equivalent to the 
'ps-BART' method described by described by Hahn, Murray, and Carvalho.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use.ranef</code></td>
<td>

<p>Logical specifying if <code>group.by</code> variable - when present - should be
included as a "random" or "fixed" effect. If true,
<code>rbart</code> will be used for BART models. Using random
effects for treatment assignment mechanisms of type <code>"glm"</code> require
that the <code>lme4</code> package be available.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group.effects</code></td>
<td>

<p>Logical specifying if effects should be calculated within groups if the
<code>group.by</code> variable is provided. Response methods of <code>"tmle"</code> and
<code>"p.weight"</code> are such that if group effects are calculated, then the
population effect is not provided.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>keepCall</code></td>
<td>

<p>A logical such that when <code>FALSE</code>, the call to <code>bartc</code> is not kept.
This can reduce the  amount of information printed by
<code>summary</code> when passing in data as literals.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>crossvalidate</code></td>
<td>

<p>One of <code>TRUE</code>, <code>FALSE</code>, <code>"trt"</code>, or <code>"rsp"</code>. Enables
code to attempt to estimate the optimal end-node sensitivity parameter. This
uses a rudimentary Bayesian optimization routine and can be extremely slow.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>

<p>A logical that when <code>TRUE</code> prints information as the model is fit.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>

<p>Optional integer specifying the desired pRNG seed. It should not be needed
when running single-threaded - <code>set.seed</code> will suffice, and can be used to
obtain reproducible results when multi-threaded. See Reproducibility section of
<code>bart2</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>args.rsp, args.trt, ...</code></td>
<td>
 
<p>Further arguments to the treatment and response model fitting algorithms.
Arguments passed to the main function as ... will be used in both models.
<code>args.rsp</code> and <code>args.trt</code> can be used to set parameters in a
single fit, and will override other values. See <code>glm</code> and
<code>bart2</code> for reference.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><code>bartc</code> represents a collection of methods that primarily use the
Bayesian Additive Regression Trees (BART) algorithm to estimate causal
treatment effects with binary treatment variables and continuous or binary
outcomes. This requires models to be fit to the response surface (distribution
of the response as a function of treatment and confounders,
<code class="reqn">p(Y(1), Y(0) | X)</code> and optionally for treatment assignment mechanism
(probability of receiving treatment, i.e. propensity score,
<code class="reqn">Pr(Z = 1 | X)</code>). The response surface model is used to impute
counterfactuals, which may then be adjusted together with the propensity score
to produce estimates of effects.
</p>
<p>Similar to <code>lm</code>, models can be specified symbolically. When the
<code>data</code> term is present, it will be added to the search path for the
<code>response</code>, <code>treatment</code>, and <code>confounders</code> variables. The
confounders must be specified devoid of any "left hand side", as they appear
in both of the models.
</p>
<p><strong>Response Surface</strong>
</p>
<p>The response surface methods included are:
</p>

<ul>
<li> <p><code>"bart"</code> - use BART to fit the response surface and produce
individual estimates <code class="reqn">\hat{Y}(1)_i</code> and
<code class="reqn">\hat{Y}(0)_i</code>. Treatment effect estimates are
obtained by averaging the difference of these across the population of
interest.
</p>
</li>
<li> <p><code>"p.weight"</code> - individual effects are estimated as in
<code>"bart"</code>, but treatment effect estimates are obtained by using a
propensity score weighted average. For the average treatment effect on
the treated, these weights are <code class="reqn">p(z_i | x_i) / (\sum z / n)</code>. For
ATC, replace <code class="reqn">z</code> with <code class="reqn">1 - z</code>. For ATE, <code>"p.weight"</code> is
equal to <code>"bart"</code>.
</p>
</li>
<li> <p><code>"tmle"</code> - individual effects are estimated as in <code>"bart"</code>
and a weighted average is taken as in <code>"p.weight"</code>, however the
response surface estimates and propensity scores are corrected by
using the Targeted Minimum Loss based Estimation method.
</p>
</li>
</ul>
<p><strong>Treatment Assignment</strong>
</p>
<p>The treatment assignment models are:
</p>

<ul>
<li> <p><code>"bart"</code> - fit a binary BART directly to the treatment using all
the confounders.
</p>
</li>
<li> <p><code>"none"</code> - no modeling is done. Only applies when using response
method <code>"bart"</code> and <code>p.scoreAsCovariate</code> is <code>FALSE</code>.
</p>
</li>
<li> <p><code>"glm"</code> - fit a binomial generalized linear model with logistic
link and confounders included as linear terms.
</p>
</li>
<li>
<p> Finally, a vector or matrix of propensity scores can be supplied.
Propensity score matrices should have a number of rows equal to the
number of observations in the data and a number of columns equal to
the number of posterior samples.
</p>
</li>
</ul>
<p><strong>Parametrics</strong>
</p>
<p><code>bartc</code> uses the <code>stan4bart</code> package, when available, to fit semi-
parametric surfaces. Equations can be given as to <code>lm</code>. Grouping
structures are also permitted, and use the syntax of <code>lmer</code>.
</p>
<p><strong>Generics</strong>
</p>
<p>For a fitted model, the easiest way to analyze the resulting fit is to use the
generics <code>fitted</code>, <code>extract</code>, and
<code>predict</code> to analyze specific quantities and
<code>summary</code> to aggregate those values into
targets (e.g. ATE, ATT, or ATC).
</p>
<p><strong>Common Support Rules</strong>
</p>
<p>Common support, or that the probability of receiving all treatment conditions
is non-zero within every area of the covariate space
(<code class="reqn">P(Z = 1 | X = x) &gt; 0</code> for all <code class="reqn">x</code> in the inferential sample), can be
enforced by excluding observations with high posterior uncertainty.
<code>bartc</code> supports two common support rules through <code>commonSup.rule</code>
argument:
</p>

<ul>
<li> <p><code>"sd"</code> - observations are cut from the inferential sample if:
<code class="reqn">s_i^{f(1-z)} &gt; m_z + a \times sd(s_j^{f(z)}</code>,
where <code class="reqn">s_i^{f(1-z)}</code> is the posteriors standard
deviation of the predicted counterfactual for observation <code class="reqn">i</code>,
<code class="reqn">s_j^f(z)</code> is the posterior standard deviation of the prediction
for the observed treatment condition of observation <code class="reqn">j</code>,
<code class="reqn">sd(s_j^{f(z)}</code> is the empirical standard deviation
of those quantities, and
<code class="reqn">m_z = max_j \{s_j^{f(z)}\}</code> for all <code class="reqn">j</code>
in the same treatment group, i.e. <code class="reqn">Z_j = z</code>. <code class="reqn">a</code> is a constant
to be passed in using <code>commonSup.cut</code> and its default is 1.
</p>
</li>
<li> <p><code>"chisq"</code> - observations are cut from the inferential sample if:
<code class="reqn">(s_i^{f(1-z)} / s_i^{f(z)})^2 &gt; q_\alpha</code>,
where <code class="reqn">s_i</code> are as above and <code class="reqn">q_\alpha</code>, is the upper
<code class="reqn">\alpha</code> percentile of a <code class="reqn">\chi^2</code> distribution with one degree
of freedom, corresponding to a null hypothesis of equal variance. The
default for <code class="reqn">\alpha</code> is 0.05, and it is specified using the
<code>commonSup.cut</code> parameter.
</p>
</li>
</ul>
<p><strong>Special Arguments</strong>
</p>
<p>Some default arguments are unconventional or are passed in a unique fashion.
</p>

<ul>
<li>
<p> If <code>n.chains</code> is missing, unlike in <code>bart2</code> a default
of 10 is used.
</p>
</li>
<li>
<p> For <code>method.rsp == "tmle"</code>, a special <code>arg.trt</code> of
<code>posteriorOfTMLE</code> determines if the TMLE correction should be
applied to each posterior sample (<code>TRUE</code>), or just the posterior
mean (<code>FALSE</code>).
</p>
</li>
</ul>
<p><strong>Missing Data</strong>
</p>
<p>Missingness is allowed only in the response. If some response values are
<code>NA</code>, the BART models will be trained just for where data are available
and those values will be used to make predictions for the missing
observations. Missing observations are not used when calculating statistics
for assessing common support, although they may still be excluded on those
grounds. Further, missing observations may not be compatible with response
method <code>"tmle"</code>.
</p>


<h3>Value</h3>

<p><code>bartc</code> returns an object of class <code>bartcFit</code>. Information about the
object can be derived by using methods <code>summary</code>,
<code>plot_sigma</code>, <code>plot_est</code>, <code>plot_indiv</code>,
and <code>plot_support</code>. Numerical quantities are recovered with the
<code>fitted</code> and
<code>extract</code> generics. Predictions for new
observations are obtained with <code>predict</code>.
</p>
<p>Objects of class <code>bartcFit</code> are lists containing items:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>method.rsp</code></td>
<td>
<p>character string specifying the method used to fit
the response surface</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method.trt</code></td>
<td>
<p>character string specifying the method used to fit
the treatment assignment mechanism</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estimand</code></td>
<td>
<p>character string specifying the targeted causal
effect</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit.rsp</code></td>
<td>
<p>object containing the fitted response model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data.rsp</code></td>
<td>
<p><code>dbartsData</code> object used when fitting the
response model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit.trt</code></td>
<td>
<p>object containing the fitted treatment model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group.by</code></td>
<td>
<p>optional factor vector containing the groups in which
treatment effects are estimated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>est</code></td>
<td>
<p>matrix or array of posterior samples of the treatment effect
estimate</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p.score</code></td>
<td>
<p>the vector of propensity scores used as a covariate in
the response model, when applicable</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>samples.p.score</code></td>
<td>
<p>matrix or array of posterior samples of the
propensity score, when applicable</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mu.hat.obs</code></td>
<td>
<p>samples from the posterior of the expected value for
individual responses under the observed treatment
regime</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mu.hat.cf</code></td>
<td>
<p>samples from the posterior of the expected value for
individual responses under the counterfactual
treatment</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>name.trt</code></td>
<td>
<p>character string giving the name of the treatment
variable in the data of <code>fit.rsp</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trt</code></td>
<td>
<p>vector of treatment assignments</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>how <code>bartc</code> was called</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.chains</code></td>
<td>
<p>number of independent posterior sampler chains in 
response model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>commonSup.rule</code></td>
<td>
<p>common support rule used for suppressing
observations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>commonSup.cut</code></td>
<td>
<p>common support parameter used to set cutoff when
suppressing observations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sd.obs</code></td>
<td>
<p>vector of standard deviations of individual posterior
predictors for observed treatment conditions</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sd.cf</code></td>
<td>
<p>vector of standard deviations of individual posterior
predictors for counterfactuals</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>commonSup.sub</code></td>
<td>
<p>logical vector expressing which observations are
used when estimating treatment effects</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use.ranef</code></td>
<td>
<p>logical for whether ranef models were used; only added
when true</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group.effects</code></td>
<td>
<p>logical for whether group-level estimates are
made; only added when true</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>a random seed for use when drawing from the posterior
predictive distribution</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Vincent Dorie: <a href="mailto:vdorie@gmail.com">vdorie@gmail.com</a>.
</p>


<h3>References</h3>

<p>Chipman, H., George, E. and McCulloch R. (2010)
BART: Bayesian additive regression trees.
<em>The Annals of Applied Statistics</em> <b>4(1)</b>, 266–298.
The Institute of Mathematical Statistics.
<a href="https://doi.org/10.1214/09-AOAS285">doi:10.1214/09-AOAS285</a>.
</p>
<p>Hill, J. L. (2011)
Bayesian Nonparametric Modeling for Causal Inference.
<em>Journal of Computational and Graphical Statistics</em> <b>20(1)</b>, 217–240.
Taylor &amp; Francis.
<a href="https://doi.org/10.1198/jcgs.2010.08162">doi:10.1198/jcgs.2010.08162</a>.
</p>
<p>Hill, J. L. and Su Y. S. (2013)
Assessing Lack of Common Support in Causal Inference Using Bayesian Nonparametrics: Implications for Evaluating the Effect of Breastfeeding on Children's Cognitive Outcomes
<em>The Annals of Applied Statistics</em> <b>7(3)</b>, 1386–1420.
The Institute of Mathematical Statistics.
<a href="https://doi.org/10.1214/13-AOAS630">doi:10.1214/13-AOAS630</a>.
</p>
<p>Carnegie, N. B. (2019)
Comment: Contributions of Model Features to BART Causal Inference Performance Using ACIC 2016 Competition Data
<em>Statistical Science</em> <b>34(1)</b>, 90–93.
The Institute of Mathematical Statistics.
<a href="https://doi.org/10.1214/18-STS682">doi:10.1214/18-STS682</a>
</p>
<p>Hahn, P. R., Murray, J. S., and Carvalho, C. M. (2020)
Bayesian Regression Tree Models for Causal Inference: Regularization, Confounding, and Heterogeneous Effects (with Discussion).
<em>Bayesian Analysis</em> <b>15(3)</b>, 965–1056.
International Society for Bayesian Analysis.
<a href="https://doi.org/10.1214/19-BA1195">doi:10.1214/19-BA1195</a>.
</p>


<h3>See Also</h3>

<p><code>bart2</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## fit a simple linear model
n &lt;- 100L
beta.z &lt;- c(.75, -0.5,  0.25)
beta.y &lt;- c(.5,   1.0, -1.5)
sigma &lt;- 2

set.seed(725)
x &lt;- matrix(rnorm(3 * n), n, 3)
tau &lt;- rgamma(1L, 0.25 * 16 * rgamma(1L, 1 * 32, 32), 16)

p.score &lt;- pnorm(x %*% beta.z)
z &lt;- rbinom(n, 1, p.score)

mu.0 &lt;- x %*% beta.y
mu.1 &lt;- x %*% beta.y + tau

y &lt;- mu.0 * (1 - z) + mu.1 * z + rnorm(n, 0, sigma)

# low parameters only for example
fit &lt;- bartc(y, z, x, n.samples = 100L, n.burn = 15L, n.chains = 2L)
summary(fit)

## example to show refitting under the common support rule
fit2 &lt;- refit(fit, commonSup.rule = "sd")
fit3 &lt;- bartc(y, z, x, subset = fit2$commonSup.sub,
              n.samples = 100L, n.burn = 15L, n.chains = 2L)
</code></pre>


</div>