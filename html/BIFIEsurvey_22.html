<div class="container">

<table style="width: 100%;"><tr>
<td>BIFIE.twolevelreg</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Two Level Regression
</h2>

<h3>Description</h3>

<p>This function computes the hierarchical two level model with
random intercepts and random slopes. The full maximum
likelihood estimation is conducted by means of an
EM algorithm (Raudenbush &amp; Bryk, 2002).
</p>


<h3>Usage</h3>

<pre><code class="language-R">BIFIE.twolevelreg( BIFIEobj, dep, formula.fixed, formula.random, idcluster,
   wgtlevel2=NULL, wgtlevel1=NULL, group=NULL, group_values=NULL,
   recov_constraint=NULL, se=TRUE, globconv=1E-6, maxiter=1000 )

## S3 method for class 'BIFIE.twolevelreg'
summary(object,digits=4,...)

## S3 method for class 'BIFIE.twolevelreg'
coef(object,...)

## S3 method for class 'BIFIE.twolevelreg'
vcov(object,...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>BIFIEobj</code></td>
<td>

<p>Object of class <code>BIFIEdata</code>
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dep</code></td>
<td>
<p>String for the dependent variable in the regression model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula.fixed</code></td>
<td>

<p>An <span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span> formula for fixed effects
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula.random</code></td>
<td>
<p>An <span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span> formula for random effects</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>idcluster</code></td>
<td>
<p>Cluster identifier. The cluster identifiers must be
sorted in the <code>BIFIE.data</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wgtlevel2</code></td>
<td>
<p>Name of Level 2 weight variable</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wgtlevel1</code></td>
<td>
<p>Name of Level 1 weight variable. This is optional.
If it is not provided, <code>wgtlevel</code> is calculated from
the total weight and <code>wgtlevel2</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group</code></td>
<td>

<p>Optional grouping variable
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group_values</code></td>
<td>

<p>Optional vector of grouping values. This can be omitted and grouping
values will be determined automatically.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>recov_constraint</code></td>
<td>
<p>Matrix for constraints of random effects covariance
matrix. The random effects are numbered according to the order in
the specification in <code>formula.random</code>. The first column in
<code>recov_constraint</code> contains the row index in the
covariance matrix, the second column the column index and the third column
the value to be fixed.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>se</code></td>
<td>
<p>Optional logical indicating whether statistical inference
based on replication should be employed. In case of <code>se=FALSE</code>,
standard errors are computed as maximum likelihood estimates under
the assumption of random sampling of level 2 clusters.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>globconv</code></td>
<td>
<p>Convergence criterion for maximum parameter change</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxiter</code></td>
<td>
<p>Maximum number of iterations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>Object of class <code>BIFIE.twolevelreg</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>digits</code></td>
<td>
<p>Number of digits for rounding output</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Further arguments to be passed</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The implemented random slope model can be written as
</p>
<p style="text-align: center;"><code class="reqn">y_{ij}=\bold{X}_{ij} \bold{\gamma}  +  \bold{Z}_{ij} \bold{u}_j +
\varepsilon_{ij}</code>
</p>

<p>where <code class="reqn">y_{ij}</code> is the dependent variable, <code class="reqn">\bold{X}_{ij}</code>
includes the fixed effects predictors (specified by <code>formula.fixed</code>)
and <code class="reqn">\bold{Z}_{ij}</code> includes the random effects predictors
(specified by <code>formula.random</code>). The random effects <code class="reqn">\bold{u}_j</code>
follow a multivariate normal distribution.
</p>
<p>The function also computes a variance decomposition of explained
variance due to fixed and random effects for the within and the
between level. This variance decomposition is conducted for the predictor
matrices <code class="reqn">\bold{X}</code> and <code class="reqn">\bold{Z}</code>. It is assumed that
<code class="reqn"> \bold{X}_{ij}=\bold{X}_j^B + \bold{X}_{ij}^W</code>.
The different sources of variance are computed by formulas as
proposed in Snijders and Bosker (2012, Ch. 7).
</p>


<h3>Value</h3>

<p>A list with following entries
</p>
<table>
<tr style="vertical-align: top;">
<td><code>stat</code></td>
<td>
<p>Data frame with coefficients and different sources
of variance.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output</code></td>
<td>
<p>Extensive output with all replicated statistics</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>More values</p>
</td>
</tr>
</table>
<h3>References</h3>

<p>Raudenbush, S. W., &amp; Bryk, A. S. (2002).
<em>Hierarchical linear models: Applications and data analysis methods</em>.
Thousand Oaks: Sage.
</p>
<p>Snijders, T. A. B., &amp; Bosker, R. J. (2012).
<em>Multilevel analysis: An introduction to basic and advanced multilevel
modeling</em>. Thousand Oaks: Sage.
</p>


<h3>See Also</h3>

<p>The <code>lme4::lmer</code> function in the <span class="pkg">lme4</span> package allows only
weights at the first level.
</p>
<p>See the <span class="pkg">WeMix</span> package (and the function <code>WeMix::mix</code>) for estimation of
mixed effects models with weights at different levels.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
library(lme4)

#############################################################################
# EXAMPLE 1: Dataset data.bifie01 | TIMSS 2011
#############################################################################

data(data.bifie01)
dat &lt;- data.bifie01
set.seed(987)

# create dataset with replicate weights and plausible values
bdat1 &lt;- BIFIEsurvey::BIFIE.data.jack( data=dat, jktype="JK_TIMSS", jkzone="JKCZONE",
            jkrep="JKCREP", wgt="TOTWGT", pv_vars=c("ASMMAT","ASSSCI") )

# create dataset without plausible values and ignoring weights
bdat2 &lt;- BIFIEsurvey::BIFIE.data.jack( data=dat, jktype="JK_RANDOM", ngr=10 )
#=&gt; standard errors from ML estimation

#***********************************************
# Model 1: Random intercept model

#--- Model 1a: without weights, first plausible value
mod1a &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat2, dep="ASMMAT01",
                formula.fixed=~ 1, formula.random=~ 1, idcluster="idschool",
                wgtlevel2="one", se=FALSE )
summary(mod1a)

#--- Model 1b: estimation in lme4
mod1b &lt;- lme4::lmer( ASMMAT01 ~ 1 + ( 1 | idschool), data=dat, REML=FALSE)
summary(mod1b)

#--- Model 1c: Like Model 1a but for five plausible values and ML inference
mod1c &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat1, dep="ASMMAT",
                formula.fixed=~ 1, formula.random=~ 1, idcluster="idschool",
                wgtlevel2="one",  se=FALSE )
summary(mod1c)

#--- Model 1d: weights and sampling design and all plausible values
mod1d &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat1, dep="ASMMAT",
                formula.fixed=~ 1, formula.random=~ 1, idcluster="idschool",
                wgtlevel2="SCHWGT" )
summary(mod1d)

#***********************************************
# Model 2: Random slope model

#--- Model 2a: without weights
mod2a &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat2, dep="ASMMAT01",
                formula.fixed=~  female +  ASBG06A, formula.random=~ ASBG06A,
                idcluster="idschool", wgtlevel2="one",  se=FALSE )
summary(mod2a)

#--- Model 2b: estimation in lme4
mod2b &lt;- lme4::lmer( ASMMAT01 ~ female +  ASBG06A + ( 1 + ASBG06A | idschool),
                   data=dat, REML=FALSE)
summary(mod2b)

#--- Model 2c: weights and sampling design and all plausible values
mod2c &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat1, dep="ASMMAT",
                formula.fixed=~  female +  ASBG06A, formula.random=~ ASBG06A,
                idcluster="idschool", wgtlevel2="SCHWGT", maxiter=500, se=FALSE)
summary(mod2c)

#--- Model 2d: Uncorrelated intecepts and slopes

# constraint for zero covariance between intercept and slope
recov_constraint &lt;- matrix( c(1,2,0), ncol=3 )
mod2d &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat2, dep="ASMMAT01",
                formula.fixed=~ female +  ASBG06A, formula.random=~ ASBG06A,
                idcluster="idschool", wgtlevel2="one",  se=FALSE,
                recov_constraint=recov_constraint )
summary(mod2d)

#--- Model 2e: Fixed entries in the random effects covariance matrix

# two constraints for random effects covariance
# Cov(Int, Slo)=0  # zero slope for intercept and slope
# Var(Slo)=10      # slope variance of 10
recov_constraint &lt;- matrix( c(1,2,0,
                      2,2,10), ncol=3, byrow=TRUE)
mod2e &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat2, dep="ASMMAT01",
                formula.fixed=~  female +  ASBG06A, formula.random=~ ASBG06A,
                idcluster="idschool", wgtlevel2="one",  se=FALSE,
                recov_constraint=recov_constraint )
summary(mod2e)

#############################################################################
# SIMULATED EXAMPLE 2: Two-level regression with random slopes
#############################################################################

#--- (1) simulate data
set.seed(9876)
NC &lt;- 100    # number of clusters
Nj &lt;- 20     # number of persons per cluster
iccx &lt;- .4   # intra-class correlation predictor
theta &lt;- c( 0.7, .3 )    # fixed effects
Tmat &lt;- diag( c(.3, .1 ) ) # variances of random intercept and slope
sig2 &lt;- .60    # residual variance
N &lt;- NC*Nj
idcluster &lt;- rep( 1:NC, each=Nj )
dat1 &lt;- data.frame("idcluster"=idcluster )
dat1$X &lt;- rep( stats::rnorm( NC, sd=sqrt(iccx) ), each=Nj ) +
                 stats::rnorm( N, sd=sqrt( 1 - iccx) )
dat1$Y &lt;- theta[1] + rep( stats::rnorm(NC, sd=sqrt(Tmat[1,1] ) ), each=Nj ) +
      theta[2] + rep( stats::rnorm(NC, sd=sqrt(Tmat[2,2])), each=Nj )) * dat1$X +
      stats::rnorm(N, sd=sqrt(sig2) )

#--- (2) create design object
bdat1 &lt;- BIFIEsurvey::BIFIE.data.jack( data=dat1, jktype="JK_GROUP", jkzone="idcluster")
summary(bdat1)

#*** Model 1: Random slope model (ML standard errors)

#- estimation using BIFIE.twolevelreg
mod1a &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat1, dep="Y",
                formula.fixed=~ 1+X, formula.random=~ 1+X, idcluster="idcluster",
                wgtlevel2="one",  se=FALSE )
summary(mod1a)

#- estimation in lme4
mod1b &lt;- lme4::lmer( Y ~ X + ( 1+X | idcluster), data=dat1, REML=FALSE  )
summary(mod1b)

#- using Jackknife for inference
mod1c &lt;- BIFIEsurvey::BIFIE.twolevelreg( BIFIEobj=bdat1, dep="Y",
                formula.fixed=~ 1+X, formula.random=~ 1+X, idcluster="idcluster",
                wgtlevel2="one",  se=TRUE )
summary(mod1c)

# extract coefficients
coef(mod1a)
coef(mod1c)
# covariance matrix
vcov(mod1a)
vcov(mod1c)

## End(Not run)
</code></pre>


</div>