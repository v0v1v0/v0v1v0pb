<div class="container">

<table style="width: 100%;"><tr>
<td>do_correction</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Integration Constraint Correction</h2>

<h3>Description</h3>

<p>Implements the correction for the integration constraint.
</p>


<h3>Usage</h3>

<pre><code class="language-R">do_correction(
  zstar,
  binwidth,
  data_prepped,
  firstpass_results,
  correct_iter_max = 200,
  notch = FALSE,
  zD_bin = NA
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>zstar</code></td>
<td>
<p>a numeric value for the the bunching point.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>binwidth</code></td>
<td>
<p>a numeric value for the width of each bin.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data_prepped</code></td>
<td>
<p>(binned) data that includes all variables necessary for fitting the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>firstpass_results</code></td>
<td>
<p>initial bunching estimates without correction.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>correct_iter_max</code></td>
<td>
<p>maximum iterations for integration constraint correction. Default is 200.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>notch</code></td>
<td>
<p>whether analysis is for a kink or notch. Default is FALSE (kink).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>zD_bin</code></td>
<td>
<p>the bin marking the upper end of the dominated region (notch case).</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>do_correction returns a list with the data and estimates after correcting for the integration constraint, as follows:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>The dataset with the corrected counterfactual.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>coefficients</code></td>
<td>
<p>The coefficients of the model fit on the corrected data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>b_corrected</code></td>
<td>
<p>The normalized excess mass, corrected for the integration constraint.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>B_corrected</code></td>
<td>
<p>The excess mass (not normalized), corrected for the integration constraint.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>c0_corrected</code></td>
<td>
<p>The counterfactual at zstar, corrected for the integration constraint.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>marginal_buncher_corrected</code></td>
<td>
<p>The location (z value) of the marginal buncher, corrected for the integration constraint.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha_corrected</code></td>
<td>
<p>The estimated fraction of bunchers in the dominated region, corrected for the integration constraint (only in notch case).</p>
</td>
</tr>
</table>
<h3>See Also</h3>

<p><code>bunchit</code>, <code>fit_bunching</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">data(bunching_data)
binned_data &lt;- bin_data(z_vector = bunching_data$kink, zstar = 10000,
                        binwidth = 50, bins_l = 20, bins_r = 20)
prepped_data &lt;- prep_data_for_fit(binned_data, zstar = 10000, binwidth = 50,
                                  bins_l = 20, bins_r = 20, poly = 4)
firstpass &lt;- fit_bunching(prepped_data$data_binned,
                          prepped_data$model_formula,
                          binwidth = 50)
corrected &lt;- do_correction(zstar = 10000, binwidth = 50,
                           data_prepped = prepped_data$data_binned,
                           firstpass_results = firstpass)
paste0("Without correction, b = ", firstpass$b_estimate)
paste0("With correction, b = ", round(corrected$b_corrected,3))
</code></pre>


</div>