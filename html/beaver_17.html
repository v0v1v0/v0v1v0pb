<div class="container">

<table style="width: 100%;"><tr>
<td>posterior_g_comp</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Compute Posterior G-Computation Estimate</h2>

<h3>Description</h3>

<p>Calculate the estimated effect for each observation
at each dose and average over all observations.  This function calculates
the posterior marginal treatment effect at each dose.
</p>


<h3>Usage</h3>

<pre><code class="language-R">posterior_g_comp(
  x,
  doses = attr(x, "doses"),
  reference_dose = NULL,
  prob = c(0.025, 0.975),
  return_stats = TRUE,
  return_samples = FALSE,
  new_data = NULL,
  reference_type = c("difference", "ratio")
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>an object output from <code>beaver_mcmc()</code> or (internal function)
<code>run_mcmc()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>doses</code></td>
<td>
<p>doses at which to obtain the posterior.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>reference_dose</code></td>
<td>
<p>dose to which to compare as either a difference or
ratio.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prob</code></td>
<td>
<p>the percentiles of the posterior to calculate for each dose.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>return_stats</code></td>
<td>
<p>logical indicating if the posterior mean and quantiles
should be returned.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>return_samples</code></td>
<td>
<p>logical indicating if posterior mean samples should
be returned.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>new_data</code></td>
<td>
<p>a dataframe containing all the variables used in the
covariate adjustments to the model used to obtain <code>x</code>.  Usually this
will be the same dataframe used to fit the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>reference_type</code></td>
<td>
<p>whether to provide the posterior of the difference or
the ratio between each dose and the reference dose.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A list with the elements <code>stats</code> and <code>samples</code>. When using this
function with default settings, <code>samples</code> is NULL and <code>stats</code> is a
dataframe summarizing the posterior samples. <code>stats</code> contains, at a
minimum, the columns "dose", "value", and variables corresponding to the
values passed in <code>prob</code> ("2.50%" and "97.50%" by default). When
<code>return_stats</code> is set to <code>FALSE</code>, <code>stats</code> is NULL. When <code>return_samples</code>
is set to <code>TRUE</code>, <code>samples</code> is a dataframe with the posterior samples for
each iteration of the MCMC.
</p>

<dl>
<dt>When x is of class 'beaver_mcmc_bma':</dt>
<dd>
<p>The dataframe will have, at a minimum, the columns "iter" and "model",
indicating the MCMC iteration and the model that was used in the
calculations, as well as the columns "dose" and "value". The functions
used for each model are defined within the <code>model_negbin_XYZ()</code>
functions and used in the <code>beaver_mcmc()</code> function.
</p>
</dd>
<dt>When x is of class 'beaver_mcmc':</dt>
<dd>
<p>The dataframe will have, at a minimum, the column "iter", indicating
the MCMC iteration, as well as the columns "dose" and "value". The
functions used for each model are defined within the
<code>model_negbin_XYZ()</code> functions and used in the <code>run_mcmc()</code> function.
</p>
</dd>
</dl>
<h3>See Also</h3>

<p>Other posterior calculations: 
<code>beaver_mcmc()</code>,
<code>posterior.beaver_mcmc_bma()</code>,
<code>posterior.beaver_mcmc()</code>,
<code>pr_eoi_g_comp()</code>,
<code>pr_eoi()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
# The {beaver} package, by definition, performs MCMC for multiple models.
# Even with a small number of chains/burn-ins/samples, a minimally illustrative
# example requires &gt;5s to run.

library(dplyr)

# No covariates----

set.seed(100)

df &lt;- data_negbin_emax(
  n_per_arm = 10,
  doses = 0:3,
  b1 = 0,
  b2 = 2.5,
  b3 = 0.5,
  ps = 0.75
)

df %&gt;%
  group_by(dose) %&gt;%
  summarize(
    mean = mean(response),
    se = sd(response) / sqrt(n()),
    .groups = "drop"
  )

mcmc &lt;- beaver_mcmc(
  emax = model_negbin_emax(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 1.5,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  linear = model_negbin_linear(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    w_prior = 1 / 4
  ),
  quad = model_negbin_quad(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 1.5,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  exp = model_negbin_exp(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 0,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  formula = ~ 1,
  data = df,
  n_iter = 1e2,
  n_chains = 1,
  quiet = TRUE
)

mcmc$w_post

draws &lt;- try(draws(mcmc)) #draws() is intended for single model fits only
draws_emax &lt;- draws(mcmc$models$emax$mcmc)
draws_linear &lt;- draws(mcmc$models$linear$mcmc)
draws_quad &lt;- draws(mcmc$models$quad$mcmc)
draws_exp &lt;- draws(mcmc$models$exp$mcmc)

post &lt;- posterior(
  mcmc,
  contrast = matrix(1, 1, 1),
  doses = 0:3,
  reference_dose = 0,
  reference_type = "difference"
)

pr_eoi(
  mcmc,
  eoi = c(5, 8),
  contrast = matrix(1, 1, 1),
  reference_dose = 0,
  reference_type = "difference"
)

post_g_comp &lt;- posterior_g_comp(
  mcmc,
  new_data = df,
  reference_dose = 0,
  reference_type = "difference"
)

pr_eoi_g_comp(
  mcmc,
  eoi = c(5, 8),
  new_data = df,
  reference_dose = 0,
  reference_type = "difference"
)

plot(mcmc, contrast = matrix(1, 1, 1))

# With covariates----

set.seed(1000)

x &lt;-
  data.frame(
    gender = factor(sample(c("F", "M"), 40, replace = TRUE))
  ) %&gt;%
  model.matrix(~ gender, data = .)

df_cov &lt;-
  data_negbin_emax(
    n_per_arm = 10,
    doses = 0:3,
    b1 = c(0, 0.5),
    b2 = 2.5,
    b3 = 0.5,
    ps = 0.75,
    x = x
  ) %&gt;%
  mutate(
    gender = case_when(
      genderM == 1 ~ "M",
      TRUE ~ "F"
    ),
    gender = factor(gender)
  ) %&gt;%
  select(subject, dose, gender, response)

df_cov %&gt;%
  group_by(dose, gender) %&gt;%
  summarize(
    mean = mean(response),
    se = sd(response) / sqrt(n()),
    .groups = "drop"
  )

mcmc_cov &lt;- beaver_mcmc(
  emax = model_negbin_emax(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 1.5,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  linear = model_negbin_linear(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    w_prior = 1 / 4
  ),
  quad = model_negbin_quad(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 1.5,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  exp = model_negbin_exp(
    mu_b1 = 0,
    sigma_b1 = 10,
    mu_b2 = 0,
    sigma_b2 = 10,
    mu_b3 = 0,
    sigma_b3 = 3,
    w_prior = 1 / 4
  ),
  formula = ~ gender,
  data = df_cov,
  n_iter = 1e2,
  n_chains = 1,
  quiet = TRUE
)

mcmc_cov$w_post

draws_cov &lt;- try(draws(mcmc_cov)) #draws() is intended for single model fits only
draws_cov_emax &lt;- draws(mcmc_cov$models$emax$mcmc)
draws_cov_linear &lt;- draws(mcmc_cov$models$linear$mcmc)
draws_cov_quad &lt;- draws(mcmc_cov$models$quad$mcmc)
draws_cov_exp &lt;- draws(mcmc_cov$models$exp$mcmc)

post_cov &lt;- posterior(
  mcmc_cov,
  contrast = matrix(c(1, 1, 0, 1), 2, 2),
  doses = 0:3,
  reference_dose = 0,
  reference_type = "difference"
)

pr_eoi(
  mcmc_cov,
  eoi = c(5, 8),
  contrast = matrix(c(1, 1, 0, 1), 2, 2),
  reference_dose = 0,
  reference_type = "difference"
)

post_g_comp_cov &lt;- posterior_g_comp(
  mcmc_cov,
  new_data = df_cov,
  reference_dose = 0,
  reference_type = "difference"
)

pr_eoi_g_comp(
  mcmc_cov,
  eoi = c(5, 8),
  new_data = df_cov,
  reference_dose = 0,
  reference_type = "difference"
)

plot(mcmc_cov, new_data = df_cov, type = "g-comp")

</code></pre>


</div>